generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  ADMIN
  VIEWER
  ACCOUNTANT
}

enum PlanTier {
  FREE
  PRO
  ELITE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  INCOMPLETE
  TRIALING
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(VIEWER)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Company {
  id             String         @id @default(uuid())
  name           String
  taxId          String?        // CNPJ
  users          User[]
  subscription   Subscription?
  transactions   Transaction[]
  scoreMetrics   ScoreMetric[]
  financials     CompanyFinancials?
  snapshots      BalanceSnapshot[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@map("companies")
}

model CompanyFinancials {
  id                String   @id @default(uuid())
  companyId         String   @unique
  company           Company  @relation(fields: [companyId], references: [id])
  cashBalance       Decimal  @db.Decimal(15, 2)
  monthlyRevenue    Decimal  @db.Decimal(15, 2)
  monthlyExpenses   Decimal  @db.Decimal(15, 2)
  totalTaxLiability Decimal  @db.Decimal(15, 2)
  overdueDebts      Decimal  @db.Decimal(15, 2) @default(0)
  updatedAt         DateTime @updatedAt

  @@map("company_financials")
}

model Subscription {
  id                   String             @id @default(uuid())
  companyId            String             @unique
  company              Company            @relation(fields: [companyId], references: [id])
  stripeCustomerId     String?
  stripeSubscriptionId String?            @unique
  planTier             PlanTier           @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodEnd     DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@map("subscriptions")
}

model Transaction {
  id          String   @id @default(uuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  date        DateTime
  amount      Decimal  @db.Decimal(15, 2)
  type        String   // 'INCOME' | 'EXPENSE'
  category    String?
  description String?
  source      String?  // 'IMPORT_XML', 'MANUAL', 'CSV'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId, date])
  @@map("transactions")
}

model ScoreMetric {
  id                 String   @id @default(uuid())
  companyId          String
  company            Company  @relation(fields: [companyId], references: [id])
  date               DateTime @default(now())
  overallScore       Int
  liquidityScore     Int
  profitabilityScore Int
  operationalScore   Int
  taxRiskScore       Int
  details            Json?    // Detailed breakdown
  createdAt          DateTime @default(now())

  @@index([companyId, date])
  @@map("score_metrics")
}

model BalanceSnapshot {
  id             String   @id @default(uuid())
  companyId      String
  company        Company  @relation(fields: [companyId], references: [id])
  date           DateTime // Snapshot date
  balance        Decimal  @db.Decimal(15, 2)
  accountsReceivable Decimal @db.Decimal(15, 2) @default(0)
  accountsPayable    Decimal @db.Decimal(15, 2) @default(0)
  createdAt      DateTime @default(now())

  @@unique([companyId, date])
  @@map("balances_snapshots")
}

model Alert {
  id        String   @id @default(uuid())
  companyId String
  type      String   // 'LOW_CASH', 'SCORE_DROP', 'TAX_RISK'
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("alerts")
}

model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique
  tier        PlanTier @default(PRO)
  description String?
  isEnabled   Boolean  @default(true)

  @@map("feature_flags")
}
